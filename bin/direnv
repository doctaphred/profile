#!/usr/bin/env bash
set -euo pipefail

# This script replaces itself with the direnv binary, then runs the given command!

{  # Defer execution until the matching brace.

    sha256=54b97cced6ac268e14b80b46e6cb9241616441692361cc2593910d72b3a8dc2a
    url=https://github.com/direnv/direnv/releases/download/v2.31.0/direnv.darwin-amd64
    # TODO: Support other platforms, and enable version updates.

    # Save the name of this file.
    filename=$(basename "$0")

    # Log to stderr.
    >&2 echo "$0: installing $filename from $url"

    # Create a temporary working directory.
    workdir="$(mktemp -d)"
    pushd "$workdir"

    # Download the file.
    # -L/--location: Follow HTTP redirects.
    curl --location "$url" >"$filename"

    # Verify the integrity of the downloaded file.
    shasum --check <<<"$sha256  $filename"

    # Make it executable.
    chmod a+x "$filename"

    # Return to the original working directory.
    popd

    # Replace this script with the downloaded file.
    mv "$workdir/$filename" "$0"

    # Clean up the temporary working directory.
    rm -rf "$workdir"

    # YOLO
    "$0" "$@"
}